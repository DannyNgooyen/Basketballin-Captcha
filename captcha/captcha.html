<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Basketballin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    html,
    body {
      background: pink;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #captcha-container {
      background: white;
      width: 390px;
      height: 300px;
    }

    /* Your style here... */
    #captcha-container img {
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="captcha-container">
    <!-- Add your CAPTCHA here: -->
    <span id="captcha-text">Get the ball through the hoop. Keep the ball moving, drag mouse to throw. </span>

    <!-- We've added a sample button. Feel free to remove it: -->
    <button id="start">
      Start!
    </button>
  </div>

  <script type="text/javascript">
    (function(window, document){
      // This is how you tell the parent window that the CAPTCHA was successful.
      function captchaSuccess() {
        window.top.postMessage("success", '*');
      }

      // a better random function with ranges for whole numbers (https://www.w3schools.com/js/js_random.asp)
      // min in inclusive, max is exclusive
      function randomRange(min, max) {
        return Math.floor(Math.random() * (max - min) + min);
      }

      // a function to randomly select an element in an array
      function randomChoice(choices) {
        return choices[randomRange(0, choices.length)];
      }

      // use the CAPTCHA dimensions as global variables
      const containerWidth = parseInt(getComputedStyle(document.getElementById("captcha-container")).width); 
      const containerHeight = parseInt(getComputedStyle(document.getElementById("captcha-container")).height); 

      const terminalVelocity = 25; // rounded the actual terminal velocity of falling basketball (https://www.youtube.com/watch?v=EDKQIeWvXjw)
      const goal = 10; // number of hoops needed for success
      let hoops = 0; // number of hoops made so far

// creating a class for all of the different characters
      class ballObject {
        constructor(src, x, y) {
          this.image = new Image();
          this.image.src = src;
          
          // position of the character
          this.image.style.position = 'absolute';
          this.x = x;
          this.y = y;
          
          // velocity of the ball, always starts at rest
          this.vx = 0; 
          this.vy = 0;

          this.width = 25; // width of the image
          this.height = 32; // height of the image
          
          // create a clickable wrapper element for ball
          this.wrapper = document.createElement('wrapper');
          this.wrapper.style.width = '42px'; 
          this.wrapper.style.height = '42px'; 
          this.wrapper.append(this.image)
          
          // place the image onto the captcha
          document.getElementById('captcha-container').appendChild(this.image);
          this.image.style.top = this.y + "px";
          this.image.style.left = this.x + "px";

          // add listeners and flags to manage mouse controls 
          this.aiming = false;
          this.initialX = null;
          this.initialY = null;
          this.dX = 0;
          this.dY = 0;
          
          // lets the ball be dragged from anywhere
          document.addEventListener('mousedown', (e) => this.handleMouseDown(e));
          document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
          document.addEventListener('mouseup', (e) => this.handleRelease(e));

          // adding touch constrols
          // lets the ball be dragged from anywhere
          document.addEventListener('touchstart', (e) => this.handleTouchStart(e), {passive:false});
          document.addEventListener('touchmove', (e) => this.handleTouchMove(e), {passive:false});
          document.addEventListener('touchend', (e) => this.handleRelease(e));
        }

        // controls to move the ball
        
        handleMouseDown(e) {
          this.aiming = true;
          this.initialX = e.clientX;
          this.initialY = e.clientY;
        }

        handleMouseMove(e) {
          if (this.aiming) {
            // update the change in mouse positions
            this.dX = e.clientX - this.initialX;
            this.dY = e.clientY - this.initialY;
          }
        }

        handleRelease(e) {
          this.aiming = false;
          this.move(this.dX, this.dY); // move ball in the same direction as mouse 
        }

        // the touch controls were heavily assisted by lunarmossy's example
        handleTouchStart(e) {
          this.aiming = true;
          this.initialX = e.touches[0].clientX;
          this.initialY = e.touches[0].clientY;
        }

        handleTouchMove (e) {
          if (this.aiming) {
            // update the change in mouse positions
            this.dX = e.touches[0].clientX - this.initialX;
            this.dY = e.touches[0].clientY - this.initialY;
          }
        }

        // move ony whenever aiming is finished
        move(dX, dY) {
          if (!this.aiming) {
            this.vx += dX / 10;
            this.vy += dY / 10;
          }
        }

        resetBall() {
          this.x = randomRange(0, containerWidth-2*25); 
          this.y = 32;
        }

        // continually update movement from gravity
        update(hoop) {
          this.x += this.vx;
          this.y += this.vy;
          this.vy += 0.981; // gravity (based on the real constant of 9.81 m/s^2)

          // applies air resistance to slow ball over time
          this.vx *= 0.95 
          this.vy *= 0.95 

          this.vy = Math.min(this.vy, terminalVelocity); // limit based on fastest velocity of ball
           
          // left wall
          if (this.x < 0) {
            this.x = 0;
            this.vy *= -0.97;
            this.vx *= -0.97;
          }

          // right wall
          else if (this.x > containerWidth-2*this.width) {
            this.x = containerWidth-2*this.width;
            this.vy *= -0.97;
            this.vx *= -0.97;
          }

          // floor (no dribbling on the floor)
          if (this.y > containerHeight-2*this.height) {
            this.y = containerHeight-2*this.height;
          }

          // ceiling
          else if (this.y < 0) {
            this.y = 0;
            this.vx *= -0.97;
            this.vy *= -0.97;
          }

          // hoop collision
          if (this.x + this.width > hoop.x &&
              this.x < hoop.x + hoop.width &&
              this.y + this.height > hoop.y &&
              this.y < hoop.y + hoop.height) {

            let basketArea = 49; // middle section that the ball can go through

            if (this.x + this.width > hoop.x + ((hoop.width - basketArea)/2) &&
                this.x < hoop.x + hoop.width - ((hoop.width - basketArea)/2)) {
                  // ball went through over the hoop
                  if (this.vy > 0) {
                    hoops += 1;
                    this.resetBall();
                    console.log("goal detected");
                    
                    if (hoops == goal) {
                      captchaSuccess();
                    }
                }
                
                // ball went through under the hoop
                else {
                  console.log("violation");
                }
              }  
            
            else {
              this.vy *= -0.97;
              this.vx *= -0.97;
              console.log("Collision detected")
            }
          }

          // effectively a dead ball
          if (Math.abs(this.vx) < 0.5 && this.vy > 17) {
            console.log("dead ball. end.")
          }

          this.image.style.top = this.y + "px";
          this.image.style.left = this.x + "px";
        }

      }

      class hoopObject {
        constructor(src, x, y) {
          this.image = new Image();
          this.image.src = src;
          
          // position
          this.image.style.position = 'absolute';
          this.x = x;
          this.y = y;
          
          this.width = 75; // width of the image
          this.height = 17; // height of the image

          // place the image onto the captcha
          document.getElementById('captcha-container').appendChild(this.image);
          this.image.style.top = this.y + "px";
          this.image.style.left = this.x + "px";
        }
      }

      function startGame() {
        const ball = new ballObject("assets/ball.png", 
                                    randomRange(0, containerWidth-2*25), 
                                    32);

        const hoop = new hoopObject("assets/hoop.png",
                                    randomRange(0, containerWidth-2*75), 60);

        // hide the start button so it doesn't get spammed
        document.getElementById("start").style.visibility = "hidden";
        document.getElementById("captcha-text").textContent = "";

      
        // keep the ball's movement updated from gravity
        setInterval(() => {
          ball.update(hoop);
        }, 36); 
    
      }

      // when hitting start
      document.getElementById("start").addEventListener("click", () => {
        startGame();
      });

    })(window, document);
  </script>
</body>
</html>
